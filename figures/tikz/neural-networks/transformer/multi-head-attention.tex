\documentclass[beamer,crop,tikz]{standalone}

\usepackage{formation}
\usepackage{tikz}
\usetikzlibrary{positioning, fit, arrows.meta, shapes, decorations.pathreplacing,decorations.markings}

% used to avoid putting the same thing several times...
% Command \empt{var1}{var2}
\newcommand{\empt}[2]{$#1^{\langle #2 \rangle}$}

\begin{document}

\begin{tikzpicture}
%Start drawing the thing...    
    % Draw the cell: 
    
    % Draw input
    \node[input] (x1) at (-0.5,-1.0) {$\vec{x}_{1}$};
    \node[input] (x2) at ( 1.5,-1.0) {$\vec{x}_{2}$};
    \node[input] (x3) at ( 3.5,-1.0) {$\vec{x}_{3}$};
    
    \node[self-attention,minimum width=6cm] (att5) at (3.0,3.0) {${auto-attention}_5$};
    \node[self-attention,minimum width=6cm] (att4) at (2.5,2.5) {${auto-attention}_4$};
    \node[self-attention,minimum width=6cm] (att3) at (2.0,2.0) {${auto-attention}_3$};
    \node[self-attention,minimum width=6cm] (att2) at (1.5,1.5) {${auto-attention}_2$};
    \node[self-attention,minimum width=6cm] (att1) at (1.0,1.0) {${auto-attention}_1$};
    
    
    \node (latt5) at ( 0.9,2.75) {};
    \node (latt4) at ( 0.4,2.25) {};
    \node (latt3) at (-0.1,1.75) {};
    \node (latt2) at (-0.6,1.25) {};
    \node (latt1) at (-1.1,0.75) {};
    
    \node (ratt5) at (5.1,2.75) {};
    \node (ratt4) at (4.6,2.25) {};
    \node (ratt3) at (4.1,1.75) {};
    \node (ratt2) at (3.6,1.25) {};
    \node (ratt1) at (3.1,0.75) {};
    
    
    \foreach \y in {1,...,5} {
        \draw[->,dashed,>=stealth] (x1.north) to (latt\y.south);
    }
    
    \foreach \y in {1,...,5} {
        \draw[->,dashed,>=stealth] (x2.north) to (att\y.south);
    }
    
    \foreach \y in {1,...,5} {
        \draw[->,dashed,>=stealth] (x3.north) to (ratt\y.south);
    }
    
    
    \node[self-attention,minimum width=6cm] (att5) at (3.0,3.0) {$\text{tête d'attention}_5$};
    \node[self-attention,minimum width=6cm] (att4) at (2.5,2.5) {$\text{tête d'attention}_4$};
    \node[self-attention,minimum width=6cm] (att3) at (2.0,2.0) {$\text{tête d'attention}_3$};
    \node[self-attention,minimum width=6cm] (att2) at (1.5,1.5) {$\text{tête d'attention}_2$};
    \node[self-attention,minimum width=6cm] (att1) at (1.0,1.0) {$\text{tête d'attention}_1$};
    
    % Draw returned vectors
    
    \node[hencoder] (r15) at (0.9,6.0) {$\vec{r}_{1,5}$};
    \node[hencoder] (r25) at (3.0,6.0) {$\vec{r}_{2,5}$};
    \node[hencoder] (r35) at (5.1,6.0) {$\vec{r}_{3,5}$};
    
    \node[hencoder] (r14) at (0.4,5.5) {$\vec{r}_{1,4}$};
    \node[hencoder] (r24) at (2.5,5.5) {$\vec{r}_{2,4}$};
    \node[hencoder] (r34) at (4.6,5.5) {$\vec{r}_{3,4}$};
    
    \node[hencoder] (r13) at (-0.1,5.0) {$\vec{r}_{1,3}$};
    \node[hencoder] (r23) at ( 2.0,5.0) {$\vec{r}_{2,3}$};
    \node[hencoder] (r33) at ( 4.1,5.0) {$\vec{r}_{3,3}$};
    
    \node[hencoder] (r12) at (-0.6,4.5) {$\vec{r}_{1,2}$};
    \node[hencoder] (r22) at ( 1.5,4.5) {$\vec{r}_{2,2}$};
    \node[hencoder] (r32) at ( 3.6,4.5) {$\vec{r}_{3,2}$};
    
    \node[hencoder] (r11) at (-1.1,4.0) {$\vec{r}_{1,1}$};
    \node[hencoder] (r21) at ( 1.0,4.0) {$\vec{r}_{2,1}$};
    \node[hencoder] (r31) at ( 3.1,4.0) {$\vec{r}_{3,1}$};

    %pouet
    
    \foreach \y in {1,...,5} {
        \foreach \r in {1,...,3} {
            \draw[->,dashed,>=stealth] (att\y.north) to[*|] (r\r\y.south);    
        }
    }

    \node[hencoder] (r15) at (0.9,6.0) {$\vec{r}_{1,5}$};
    \node[hencoder] (r25) at (3.0,6.0) {$\vec{r}_{2,5}$};
    \node[hencoder] (r35) at (5.1,6.0) {$\vec{r}_{3,5}$};
    
    \node[hencoder] (r14) at (0.4,5.5) {$\vec{r}_{1,4}$};
    \node[hencoder] (r24) at (2.5,5.5) {$\vec{r}_{2,4}$};
    \node[hencoder] (r34) at (4.6,5.5) {$\vec{r}_{3,4}$};
    
    \node[hencoder] (r13) at (-0.1,5.0) {$\vec{r}_{1,3}$};
    \node[hencoder] (r23) at ( 2.0,5.0) {$\vec{r}_{2,3}$};
    \node[hencoder] (r33) at ( 4.1,5.0) {$\vec{r}_{3,3}$};
    
    \node[hencoder] (r12) at (-0.6,4.5) {$\vec{r}_{1,2}$};
    \node[hencoder] (r22) at ( 1.5,4.5) {$\vec{r}_{2,2}$};
    \node[hencoder] (r32) at ( 3.6,4.5) {$\vec{r}_{3,2}$};
    
    \node[hencoder] (r11) at (-1.1,4.0) {$\vec{r}_{1,1}$};
    \node[hencoder] (r21) at ( 1.0,4.0) {$\vec{r}_{2,1}$};
    \node[hencoder] (r31) at ( 3.1,4.0) {$\vec{r}_{3,1}$};

    
    \node[feedforward,minimum width=6cm] (feedforward) at (2.2,8.0) {couche dense};
    \node (feedforward1) at ( 0.1,7.75) {};
    \node (feedforward2) at ( 2.2,7.75) {};
    \node (feedforward3) at ( 4.3,7.75) {};

    \node[output] (z1) at ( 0.1,9.5) {$\vec{z}_{1}$};
    \node[output] (z2) at ( 2.2,9.5) {$\vec{z}_{2}$};
    \node[output] (z3) at ( 4.3,9.5) {$\vec{z}_{3}$};


    \foreach \y in {1,...,5} {
        \foreach \r in {1,...,3} {
            \draw[->,dashed,>=stealth] (r\r\y.north) to (feedforward\r);    
        }
    }

    \foreach \y in {1,...,3} {
        \draw[->,dashed,>=stealth] (feedforward.north) to[*|] (z\y.south);    
    }
% Start connecting all.
    %Intersections and displacements are used. 
    % Drawing arrows    
    % \draw [->, ArrowC1,>=stealth] (p1) |- (s1);
    % \draw [->, ArrowC1,>=stealth] (p2) |- (s2);
    % \draw [->, ArrowC1,>=stealth] (p3) |- (s3);
    % \draw [->, ArrowC1,>=stealth] (x1) to (s1);
    % \draw [->, ArrowC1,>=stealth] (x2) to (s2);
    % \draw [->, ArrowC1,>=stealth] (x3) to (s3);
    % \foreach \y in {1,...,3} {
    %     \draw[<-,thick,>=stealth] (feedforward.south) to[*|] (v\y.north);    
    % }
    % \foreach \y in {1,...,3} {
    %     \draw[->,thick,>=stealth] (feedforward.north) to[*|] (r\y.south);    
    % }

\end{tikzpicture}
\end{document}